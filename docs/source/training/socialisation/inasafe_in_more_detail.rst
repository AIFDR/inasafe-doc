.. _insafe-in-more-detail:

|project_name| in More Detail
=============================

**Objectives:**

* To interrogate the results using simple GIS tools (Zoom in, Zoom full,
  Information and Measurement tools)
* To add a new hazard layer, read its attribute table, and symbolise based on
  attribute
* To create a keyword for the new hazard layer
* To run |project_name| with the new hazard layer
* To run |project_name| and add the percentage of affected people who will need
  evacuation
* To aggregate the results

**Expected Results:**

Participants are able to:

* use simple GIS tools like zoom in, zoom full, information and measurement
  tools and interrogate its attribute table
* add a new vector layer and symbolised based on attribute
* create a keyword file for a hazard layer
* understand the difference between a model hazard and a footprint hazard
* input the percentage of people that will need evacuating for a flood
  footprint hazard
* aggregate impact results by administration areas


Interrogating the output data
-----------------------------

You should now have three or four layers that have been generated by |project_name|.

* *Population which need evacuating* - Raster Data (two layers)

* *Estimated buildings affected* - Vector Data (one or two layers)

Next let's use basic QGIS tools to examine the datasets.

===========================================     ====================
**Symbol**                                      **Name**
-------------------------------------------     --------------------
.. image:: /static/general/icon_identify.*      Identify Features
.. image:: /static/general/icon_attribute.*     Open Attribute Table
.. image:: /static/general/icon_line.*          Measure Line
.. image:: /static/general/icon_area.*          Measure Area
.. image:: /static/general/icon_zoomlayer.*     Zoom to Layer
.. image:: /static/general/icon_zoomin.*        Zoom In
.. image:: /static/general/icon_addvector.*     Add Vector Layer
===========================================     ====================


Estimated buildings affected
.............................

1. Click the Zoom In tool to and click in the map area. Zoom in to a cluster of buildings.

Here we have zoomed to a location showing two rivers going through the middle of Jakarta.

.. image:: /static/training/socialisation/042_buildings_zoom.*
   :align: center

.. note:: The red buildings are situated in water greater than one metre
   while the green buildings are determined to be unaffected since they are in
   water less than the threshold of one metre.

2. Click :guilabel:`Estimated buildings affected` in the Layers panel to select it.
   The layer name will be highlighted in blue.

.. image:: /static/training/socialisation/043_highlight.*
   :align: center

3. Click the Identify Features tool and then click on a building.

Here we selected the building circled above, which causes the attributes
of the building to be shown in a new window.

.. image:: /static/training/socialisation/044_identifyresults.*
   :align: center
.. note:: The data collected for each building in this tutorial was gathered by 
   provincial disaster managers through an OpenStreetMap data collection
   program.  They collect important structures and essential information
   about each building, such as its name, address, type and structural
   information.

4. Click the Zoom to Layer tool. This will return the map view to the extent of the
   :guilabel:`Estimated buildings affected` layer.


Population which needs evacuation
..................................

5. In the Layers panel uncheck :guilabel:`Estimated buildings
   affected` and check one of layers named :guilabel:`Population which need
   evacuation`.

6. Select :guilabel:`Population which need evacuation` in the Layers panel 
to select it. The layer name will be highlighted in blue.

7. Zoom In to an area of your choice.

8. Use the Identify Features tool to select a pixel (square) of
   the selected layer, :guilabel:`Population which need evacuation`.

Here we clicked on one of the light green pixels and find that there is a
value of 80.6411, which means there are approximately 80 people in one
pixel (square). In this dataset one pixel represents a hectare, or 100 x 100 metres.

.. image:: /static/training/socialisation/045_examineraster.*
   :align: center

9. Use the Identify Features tool to select other pixels to find
   out their value.

10. Close the Identify Results window.

11. Is each pixel really 100m by 100m? We can check by using the 
    Measure Line tool. It may be easier to measure one pixel by zooming in close.

The answer is yes, a pixel is 100 metres across, and if you measure from top
to bottom it will also be 100 metres.

.. image:: /static/training/socialisation/046_measuretest.*
   :align: center

As you can see above we measured 102 metres, but this is only because its hard to
click precisely on the corners of a single pixel.

12. Close the Measure window.

13. Click the Zoom to Layer button to return to the full extent of the
    selected layer.

14. Uncheck all layers except:

* buildings
* people


Flood footprint in |project_name|
---------------------------------

Adding a vector layer
.....................

15. Click the Add Vector Layer button.

16. Click Browse and navigate to the :file:`data` folder within
:file:`InaSAFE Projects`. Select :file:`flood_osm_bpbd18113_jakarta.shp`
and click open.

.. image:: /static/training/socialisation/047_jakarta18113.*
   :align: center

This dataset contains subvillage boundaries for Jakarta. During the floods 
in January 2013 provincial disaster managers collected information about the 
flooding, including the location of the flooded area by sub-village boundary.

.. note:: The |project_name| panel may show the warning "Layer
   keywords missing." We will address this concern later on.

Let's examine the data by opening its attribute table.

17. Make sure :guilabel:`flood_osm_bpbd18113_jakarta` layer is selected (highlighted
    blue in the Layers panel). Click the Open Attribute Table button.

.. image:: /static/training/socialisation/048_attributetable.*
   :align: center

::

  The columns in the attribute table are as follows:

  OBJECTID:  Feature ID
  KAB_NAME:  District
  KEC_NAME:  Sub-district
  KEL_NAME:  Village
  RW:        Sub-village
  affected:  1 = affected
             0 = not affected

.. note:: The information in the attribute table is the same as that shown
   with the Identify Feature tool, but instead of viewing only one object's
   attributes, we can see all of the objects at once.

18. Close the attribute table.

Symbolising vector
..................

Now let's stylise the subvillage administration boundary to only
see the flood affected (affected = 1) areas.

19. Double click on the :guilabel:`flood_osm_bpbd18113_jakarta` layer - this
    will open up the layer properties window.

20. Navigate to the style tab.

.. image:: /static/training/socialisation/049_styletab.*
   :align: center

21. Follow the steps below to stylise the subvillage boundaries as
    illustrated in the picture and table below. The numbered steps
    are shown in the image below.

==========    ================================================
**Number**    **Step**
----------    ------------------------------------------------
1             Select :guilabel:`Categorised` from the drop down menu.
2             Select :guilabel:`affected` from the Column drop down menu.
3             Click the Classify button.
4             Highlight the row with the light blue square that reads "0 0".
5             Click the Delete button.
6             Highlight the row with the dark blue square.
7             Click the Delete button.
8             Confirm there is only have one row left.
9             Click OK to close the layer properties window.
==========    ================================================

.. image:: /static/training/socialisation/050_layerproperties.*
   :align: center

The map will look something like this:

.. image:: /static/training/socialisation/051_styleflood.*
   :align: center

You have now symbolised your first layer!
You will see only the subvillage areas that were flooded on the 18th of
January.
Now, how can we use this hazard layer in |project_name|?

Adding Keywords
...............

22. As we mentioned previously the |project_name| panel shows a warning.
    |project_name| is telling us that the :guilabel:`flood_osm_bpbd18113_jakarta`
    layer has no keywords. Click on the Keyword button on the |project_name|
    toolbar.

.. image:: /static/training/socialisation/052_keyword.*
   :align: center


23. In the Keywords Editor window we can change several keyword
    fields. Enter the following into the form:

==============  ================================================
**Field**       **Input**
--------------  ------------------------------------------------
Title           :kbd:`Jakarta flooding on the 18th January 2013`
Category        :kbd:`Hazard`
Subcategory     :kbd:`flood[wet/dry]`
Source          :kbd:`BPBD DKI Jakarta`
==============  ================================================

.. image:: /static/training/socialisation/053_keywordedited.*
   :align: center

24. Click :guilabel:`OK` to close the keyword editor.

Next we will run |project_name| again with this new flood hazard footprint.

.. note:: For more information about keywords have a look in
   :doc:`../../user-docs/application-help/keywords`

Buildings within affected subvillages
.....................................

25. Confirm that |project_name| has the following in its drop-down
    menus.

.. image:: /static/training/socialisation/054_inasafepanel.*
   :align: center

* Jakarta flooding on the 18th January 2013
* buildings
* Be flooded

26. Click :guilabel:`Run`

.. note:: This may take about a minute to run.

::

  How many estimated buildings were flooded?
  Answer  ___________________

27. Read through the |project_name| results, how are they different to the
    previous |project_name| building analysis?

::

  Why are the results so different?
  Consider the differences between the hazard layers, model vs footprint.
  Answer  ______________
  Which hazard is more accurate, or are there other factors to consider?
  Answer  ______________

28. Click |project_name|:guilabel:`Print...` and save the output.

Now that we have run |project_name| to find out how many buildings might be
affected by the affected subvillage boundaries, lets find out how many people.

Evacuation as a percentage
..........................

.. note:: We were able to determine how many people needed to be evacuated in
   the last scenario by specifying how deep the water had to be for the
   location to be determined unsafe.
   However when you don`t know how deep the water is and you only know the extent
   of the flooded area, it is hard to determine how many people will need evacuating.
   |project_name| therefore needs your help!

Instead of determining how many people will be evacuated by a spatial area,
this scenario will use the affected population.
|project_name| asks the user to input a percentage of the affected population
that may need evacuating.

29. Uncheck :guilabel:`buildings` in the layers panel and instead
    check :guilabel:`people`.

30. Confirm that the |project_name| panel has the following its drop-down menus:

* Jakarta flooding on the 18th January 2013
* people
* Need Evacuation

31. To configure the impact function click the :guilabel:`Options...` button
    *Configure Impact Function Parameter* which is found beside the
    *Need Evacuation*

.. image:: /static/training/socialisation/055_inasafeconfigure.png
   :align: center

.. note:: Within the Impact Function Configuration window you are
   able to change not only the percentage of evacuated people but also the
   ratio of youth/adult/elder and the amount of minimum needs per person per
   week.
   **Improvement:** need to add units to minimum needs

32. In the options tab you can see that default is 1, for this first analysis
    we will keep this figure. Click :guilabel:`OK`.

33. Run |project_name| again.

.. note:: *This may take about a minute to run*

::

 How many people were evacuated?
 Answer __________________________
 How many people were affected?
 Answer __________________________

34. Read through the |project_name| results, how different is this to the
    previous |project_name| people analysis?

35. :guilabel:`Print` |project_name|, save accordingly

Comparing Results - Optional
----------------------------

You have now completed the following runs

=============  =============  =============  ============  =============  ===================  =============
**Hazard**     **Threshold**  **Data Type**  **Exposure**  **Data Type**  **Impact function**  **Data Type**
-------------  -------------  -------------  ------------  -------------  -------------------  -------------
flood model    1.0m           Raster         People        Raster         Need Evacuation
flood model    0.8m           Raster         People        Raster         Need Evacuation
flood model    1.0m           Raster         Buildings     Vector         Be flooded
flood 180113                  Vector         Buildings     Vector         Be flooded
flood 180113   1%             Vector         People        Raster         Need Evacuation
=============  =============  =============  ============  =============  ===================  =============

36. Complete the last column of the above table. For more information on data
    type go to :doc:`rastervsvector`

::

  How different are the results?
  Answer __________________________,
  Why are they different?
  Answer __________________________

Basic Aggregation
----------------------------

Going through this training, you probably thinking thats great but what if I
want to breakdown the impacted results by an administration boundary,
in this section we show you how.

First we need to add an administration boundary, the boundary we are going
to use is the mainland district boundaries of Jakarta (Jakarta has 6
districts, but we will be only looking at 5 because the 6th is the Thousand
Island -as the name suggest its a huge amount of islands!)

37. Use the :guilabel:`Add Vector` button

38. Use :guilabel:`Browse` to navigate to the *data* folder within
    *InaSAFE Projects*, :guilabel:`Select` *district_osm_jakarta.shp*,
    :guilabel:`Open` in the **Open an OGR Support** window and
    :guilabel:`Open` again in the **Source** window.

.. image:: /static/training/socialisation/056_district.png
   :align: center

39. This layer already has its keywords filled out, lets go through these:

Category: postprocessing - *Layer to be used after impact is derived*

Aggregation attribute: KAB_NAME - *The name of the attribute you wan to aggregate*

Subcategory: aggregation

Title: District's of Jakarta

Source: OpenStreetMap

Female ratio attribute: PEREMPUAN -
*Attribute name of female percentage per district*

By looking at the district layer attribute table you can see that the names
of the attribute correspond.

.. image:: /static/training/socialisation/057_districtattribute.png
   :align: center

40. :guilabel:`Select` the *District's of Jakarta* from the drop down menu
    under *Aggregate results by*, and check that the other sections are field
    out according to the image below.

.. image:: /static/training/socialisation/058_aggregationselect.png
   :align: center

41. :guilabel:`Run` |project_name|

.. note:: *This may take about a minute to run*

.. image:: /static/training/socialisation/059_aggregationresults.png
   :align: center

42. Lets see what the results would be for buildings,
    change How many *people* to How many *buildings*

43. :guilabel:`Run` |project_name|

.. note:: *This may take about a minute to run*

.. image:: /static/training/socialisation/060_buildingaggregationresult.*
   :align: center
