.. _insafe-in-more-detail:

|project_name| in More Detail
=============================

**Learning Objectives:**

* Learn to interrogate |project_name| results using simple GIS tools, such
  as zooming, information, and measurement tools
* Add a new hazard layer, read its attribute table, and symbolise it based on
  its attributes
* Create |project_name| keywords for the new hazard layer
* Understand the difference between a model hazard and a footprint hazard
* Adjust the percentage of affected people who will need evacuation
* Aggregate |project_name| results by administrative boundaries

.. note:: This module continues from the previous section, :doc:`run_basic_inasafe`.

Interrogating the output data
-----------------------------

You should now have several layers that have been generated by |project_name|.

* *Population which need evacuating* - Raster Data (two layers)
* *Estimated buildings affected* - Vector Data (one or two layers)

Next let's use basic QGIS tools to examine the datasets.

===========================================     ====================
**Symbol**                                      **Name**
-------------------------------------------     --------------------
.. image:: /static/general/icon_identify.*      Identify Features
.. image:: /static/general/icon_attribute.*     Open Attribute Table
.. image:: /static/general/icon_line.*          Measure Line
.. image:: /static/general/icon_area.*          Measure Area
.. image:: /static/general/icon_zoomlayer.*     Zoom to Layer
.. image:: /static/general/icon_zoomin.*        Zoom In
.. image:: /static/general/icon_addvector.*     Add Vector Layer
===========================================     ====================


Estimated buildings affected
.............................

1. Click the Zoom In tool to and click in the map area. Zoom in to a cluster of buildings.

Here we have zoomed to a location showing two rivers going through the middle of Jakarta.

.. image:: /static/training/socialisation/042_buildings_zoom.*
   :align: center

.. note:: The red buildings are situated in water greater than one metre
   while the green buildings are determined to be unaffected since they are in
   water less than the threshold of one metre.

2. Click :guilabel:`Estimated buildings affected` in the Layers panel to select it.
   The layer name will be highlighted in blue.

.. image:: /static/training/socialisation/043_highlight.*
   :align: center

3. Click the Identify Features tool and then click on a building.

Here we selected the building circled above, which causes the attributes
of the building to be shown in a new window or panel.

.. image:: /static/training/socialisation/044_identifyresults.*
   :align: center
.. note:: The data collected for each building in this tutorial was gathered by 
   provincial disaster managers through an OpenStreetMap data collection
   program.  They collect important structures and essential information
   about each building, such as its name, address, type and structural
   information.

4. Click the Zoom to Layer tool. This will return the map view to the extent of the
   :guilabel:`Estimated buildings affected` layer.


Population which needs evacuation
..................................

5. In the Layers panel uncheck :guilabel:`Estimated buildings
   affected` and check one of layers named :guilabel:`Population which need
   evacuation`.

6. Select :guilabel:`Population which need evacuation` in the Layers panel 
   to select it. The layer name will be highlighted in blue.

7. Zoom in to an area of your choice.

8. Use the Identify Features tool to select a pixel (square) of
   the selected layer, :guilabel:`Population which need evacuation`.

Here we clicked on one of the light green pixels and find that there is a
value of 80.6411, which means there are approximately 80 people in one
pixel (square). In this dataset one pixel represents a hectare, or 100 x 100 metres.

.. image:: /static/training/socialisation/045_examineraster.*
   :align: center

9. Use the Identify Features tool to select other pixels to find
   out their value.

10. Close the Identify Results window.

11. Is each pixel really 100m by 100m? We can check by using the 
    Measure Line tool. It may be easier to measure one pixel by zooming in close.
    After selecting the tool, click on two corners of a single pixel. The result
    should be approximately 100 metres.

.. image:: /static/training/socialisation/046_measuretest.*
   :align: center

As you can see above we measured 102 metres, but this is only because its hard to
click precisely on the corners of a single pixel.

12. Close the Measure window.

13. Click the Zoom to Layer button to return to the full extent of the
    selected layer.

14. Uncheck all layers except:

    * buildings
    * people


Flood footprint in |project_name|
---------------------------------

Adding a vector layer
.....................

15. Click the Add Vector Layer button.

16. Click :guilabel:`Browse` and navigate to the :file:`data` folder within
the InaSAFE tutorial data folder. Select :file:`flood_osm_bpbd18113_jakarta.shp`
and click :guilabel:`Open`.

.. image:: /static/training/socialisation/047_jakarta18113.*
   :align: center

This dataset contains subvillage boundaries for Jakarta. During the floods 
in January 2013 provincial disaster managers collected information about the 
flooding, including the location of the flooded area by sub-village boundary.

.. note:: The |project_name| panel may show the warning "Layer
   keywords missing." We will address this concern later on.

Let's examine the data by opening its attribute table.

17. Make sure :guilabel:`flood_osm_bpbd18113_jakarta` layer is selected (highlighted
    blue in the Layers panel). Click the Open Attribute Table button.

.. image:: /static/training/socialisation/048_attributetable.*
   :align: center

::

  The columns in the attribute table are as follows:

  OBJECTID:  Feature ID
  KAB_NAME:  District
  KEC_NAME:  Sub-district
  KEL_NAME:  Village
  RW:        Sub-village
  affected:  1 = affected
             0 = not affected

.. note:: The information in the attribute table is the same as that shown
   with the Identify Feature tool, but instead of viewing only one object's
   attributes, we can see all of the objects at once.

18. Close the attribute table.

Symbolising vector
..................

Now let's stylise the subvillage administration boundary to only
see the flood affected (affected = 1) areas.

19. Double click on the :guilabel:`flood_osm_bpbd18113_jakarta` layer - this
    will open up the layer properties window.

20. Navigate to the style tab.

.. image:: /static/training/socialisation/049_styletab.*
   :align: center

21. Click the drop-down menu where it says :guilabel:`Single Symbol` and
    instead select :guilabel:`Categorized`.

22. In the drop-down menu next to :guilabel:`Column`, select :guilabel:`affected`.

23. Click the Classify button. Three rows will appear with coloured boxes and
    numbers next to them.

24. Select the first row with the coloured box that reads "0 0"
    and click the Delete button.

25. Select the row with the coloured box with no text next to it
    and click the Delete button.

26. Confirm there is only one row left. Click :guilabel:`OK` to close the
    layer properties window.

.. image:: /static/training/socialisation/050_layerproperties.*
   :align: center

The map will look something like this:

.. image:: /static/training/socialisation/051_styleflood.*
   :align: center

We've now symbolised the layer! Only the subvillage areas that were flooded on 
the 18th of January are shown. Now, how can we use this hazard layer 
in |project_name|?

Adding Keywords
...............

27. Be sure that the :guilabel:`flood_osm_bpbd18113_jakarta` layer is selected.
    As we mentioned previously the |project_name| panel shows a warning.
    |project_name| is telling us that the layer has no keywords. Click on 
    the Keyword button on the |project_name| toolbar.

28. In the Keywords Editor window we can change several keyword
    fields. Enter the following into the form:

==============  ================================================
**Field**       **Input**
--------------  ------------------------------------------------
Title           :kbd:`Jakarta flooding on the 18th January 2013`
Category        :kbd:`Hazard`
Subcategory     :kbd:`flood[wet/dry]`
Source          :kbd:`BPBD DKI Jakarta`
==============  ================================================

.. image:: /static/training/socialisation/053_keywordedited.*
   :align: center

29. Click :guilabel:`OK` to close the keyword editor.

Next we will run |project_name| again with this new flood hazard footprint.

.. note:: For more information about keywords have a look in
   :doc:`../../user-docs/application-help/keywords`

Buildings within affected subvillages
.....................................

30. Confirm that |project_name| has the following in its drop-down
    menus.

* Jakarta flooding on the 18th January 2013
* Buildings
* Be flooded

.. image:: /static/training/socialisation/054_inasafepanel.*
   :align: center

31. Click :guilabel:`Run`.

::

  How many buildings does |project_name| estimate were flooded?
  Answer  ___________________

32. Read through the |project_name| results, how are they different to the
    previous |project_name| building analysis?

::

  Why are the results so different?
  Consider the differences between the hazard layers, model vs footprint.
  Answer  ______________
  Which hazard is more accurate, or are there other factors to consider?
  Answer  ______________

33. Click :guilabel:`Print...` and save the output.

Now that we have run |project_name| to find out how many buildings might be
affected within the affected subvillage boundaries, let's find out how many people.

Evacuation as a percentage
..........................

.. note:: We were able to determine how many people needed to be evacuated 
   previously by specifying how deep the water had to be for the
   location to be determined unsafe.
   However when you don`t know how deep the water is and you only know the extent
   of the flooded area, it is hard to determine how many people will need evacuating.
   |project_name| therefore needs your help!

Instead of determining how many people will be evacuated by a spatial area,
the following scenario will calculate the affected population.
|project_name| asks the user to input a percentage of the affected population
that may need evacuating.

34. Uncheck :guilabel:`buildings` in the Layers panel and instead
    check :guilabel:`people`.

35. Confirm that the |project_name| panel has the following in its drop-down menus:

* Jakarta flooding on the 18th January 2013
* people
* Need evacuation

36. To configure the impact function click the :guilabel:`Options...` button.
    There are three tabs in the Options window which can be edited.
    
.. image:: /static/training/socialisation/055_inasafeconfigure.png
   :align: center

.. note:: Within the Impact Function Configuration window we are
   able to change not only the percentage of evacuated people but also the
   ratio of youth/adult/elder and the minimum needs per person per week.

37. In the options tab you can see that default is 1. For the first analysis
    we will keep this figure. Click :guilabel:`OK`.

38. Run |project_name| again.

::

 How many people were evacuated?
 Answer __________________________
 How many people were affected?
 Answer __________________________

39. Read through the |project_name| results, how different is this to the
    previous |project_name| people analysis?

40. Click :guilabel:`Print` and save accordingly.

Comparing Results - Optional
----------------------------

You have now completed the following runs

=============  =============  =============  ============  =============  ===================  =============
**Hazard**     **Threshold**  **Data Type**  **Exposure**  **Data Type**  **Impact function**  **Data Type**
-------------  -------------  -------------  ------------  -------------  -------------------  -------------
flood model    1.0m           Raster         People        Raster         Need Evacuation
flood model    0.8m           Raster         People        Raster         Need Evacuation
flood model    1.0m           Raster         Buildings     Vector         Be flooded
flood 180113                  Vector         Buildings     Vector         Be flooded
flood 180113   1%             Vector         People        Raster         Need Evacuation
=============  =============  =============  ============  =============  ===================  =============

41. Complete the last column of the above table. For more information on data
    type go to :doc:`rastervsvector`

::

  How different are the results?
  Answer __________________________,
  Why are they different?
  Answer __________________________

Basic Aggregation
----------------------------

What if you want to break down the impact results using administrative
boundaries? We will examine how to accomplish it in this section.

First we need to add administrative boundaries to our project. The boundaries
we will use are the mainland district boundaries of Jakarta (Jakarta has six
districts, but we will be only looking at five because the sixth is the Thousand
Islands - as the name suggests it is a huge amount of islands!)

42. Click the :guilabel:`Add Vector` button.

43. Click :guilabel:`Browse` and navigate to the :file:`data` folder within
    the InaSAFE tutorial data folder. Select :file:`district_osm_jakarta.shp`
    and click :guilabel:`Open`. Click :guilabel:`Open` again to load the layer.
    
.. image:: /static/training/socialisation/056_district.png
   :align: center

44. This layer already has its keywords filled out, which can be seen in the
    |project_name| panel or by opening the keywords editor. Some of the keywords 
    for this boundary layer are as follows:

**Category:** postprocessing - Meaning this layer is to be used after the impact
is calculated

**Title:** District's of Jakarta

**Aggregation attribute:** KAB_NAME - This is the column in the attribute table
that will be used for aggregating the output.

**Female ratio attribute:** PEREMPUAN - This is a column indicating the female/male
ration in each district, which will be used in the impact calculation.

If you look at the attribute table, you will see the various values for these fields
in each administrative area.

.. image:: /static/training/socialisation/057_districtattribute.png
   :align: center

45. Click the drop-down menu under :guilabel:`Aggregate results by` and select
    :guilabel:`District's of Jakarta`. Ensure that the other |project_name|
    fields are as in the image below:

.. image:: /static/training/socialisation/058_aggregationselect.png
   :align: center

46. Run |project_name|.

The population results will be similar to previous scenarios, but now the 
statistics are also divided by administrative boundaries.

.. image:: /static/training/socialisation/059_aggregationresults.png
   :align: center

47. Let's check the results for affected buildings aggregated by district as 
    well. Change the |project_name| settings to query buildings instead of
    population.

48. Run |project_name| again. Your results should look similar to the following:

.. image:: /static/training/socialisation/060_buildingaggregationresult.*
   :align: center
